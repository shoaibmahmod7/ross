import numpy as np
import pytest
from numpy.testing import assert_allclose

import ross as rs
from ross.units import Q_


@pytest.fixture
def rotor():
    steel2 = rs.Material(name="Steel", rho=7850, E=2.17e11, Poisson=0.2992610837438423)

    #  Rotor with 6 DoFs, with internal damping, with 10 shaft elements, 2 disks and 2 bearings.
    i_d = 0
    o_d = 0.019

    # fmt: off
    L = np.array([
        0  ,  25,  64, 104, 124, 143, 175, 207, 239, 271,
        303, 335, 345, 355, 380, 408, 436, 466, 496, 526,
        556, 586, 614, 647, 657, 667, 702, 737, 772, 807,
        842, 862, 881, 914
    ])/ 1000
    # fmt: on

    L = [L[i] - L[i - 1] for i in range(1, len(L))]

    shaft_elem = [
        rs.ShaftElement6DoF(
            l,
            i_d,
            o_d,
            material=steel2,
            alpha=8.0501,
            beta=1.0e-5,
        )
        for l in L
    ]

    Id = 0.003844540885417
    Ip = 0.007513248437500

    disk0 = rs.DiskElement6DoF(n=12, m=2.6375, Id=Id, Ip=Ip)
    disk1 = rs.DiskElement6DoF(n=24, m=2.6375, Id=Id, Ip=Ip)

    kxx1 = 4.40e5
    kyy1 = 4.6114e5
    kzz = 0
    cxx1 = 27.4
    cyy1 = 2.505
    czz = 0
    kxx2 = 9.50e5
    kyy2 = 1.09e8
    cxx2 = 50.4
    cyy2 = 100.4553

    bearing0 = rs.BearingElement6DoF(
        n=4, kxx=kxx1, kyy=kyy1, kzz=kzz, cxx=cxx1, cyy=cyy1, czz=czz
    )
    bearing1 = rs.BearingElement6DoF(
        n=31, kxx=kxx2, kyy=kyy2, kzz=kzz, cxx=cxx2, cyy=cyy2, czz=czz
    )

    return rs.Rotor(shaft_elem, [disk0, disk1], [bearing0, bearing1])


@pytest.fixture
def rub(rotor):
    unbalance_magnitude = np.array([5e-4, 0])
    unbalance_phase = Q_(np.array([-90.0, 0.0]), "degrees")

    return rotor.run_rubbing(
        dt=0.001,
        tI=0,
        tF=0.5,
        deltaRUB=7.95e-5,
        kRUB=1.1e6,
        cRUB=40,
        miRUB=0.3,
        posRUB=12,
        speed=Q_(1200, "RPM"),
        unbalance_magnitude=unbalance_magnitude,
        unbalance_phase=unbalance_phase,
        print_progress=False,
    )


def test_rub_parameters(rub):
    assert rub.dt == 0.001
    assert rub.tI == 0
    assert rub.tF == 0.5
    assert rub.deltaRUB == 7.95e-5
    assert rub.kRUB == 1.1e6
    assert rub.cRUB == 40
    assert rub.miRUB == 0.3
    assert rub.posRUB == 12
    assert rub.speed == 125.66370614359172


def test_rub_forces(rub):
    # fmt: off
    Fx_rub = np.array([
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         1.34377,   2.38806,   2.49916,   1.81395,   0.599  ,  -1.62394,
        -4.23779,  -6.0012 ,  -6.20606,  -4.74044,  -2.73606,  -2.59117,
        -6.09753, -11.90441, -16.29645, -16.419  , -12.30249,  -6.48021,
        -1.92542,   0.03546,   0.14775,   0.06315,   0.18367,   0.44434,
         0.59336,   0.55256,   0.61928,   1.1632 ,   1.99649,   2.28978,
         1.22352,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,  -0.15535,  -1.14814,  -1.31374,
        -0.57377,   0.17469,   0.     ,   0.     ,   0.     ,   0.     ,
         1.36008,   4.63287,   8.26195,  10.76651,  11.33296,   9.97955,
         7.45322,   4.82873,   2.92041,   1.94037,   1.61479,   1.51651,
         1.30659,   0.82727,   0.11565,  -1.19318,  -2.29413,  -2.84508,
        -2.70601,  -1.71827,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,  -0.36415,  -0.02201,  -0.58344,  -1.2737 ,
        -1.38591,  -0.83953,   0.     ,  -1.51706,  -3.87348,  -5.83944,
        -5.56822,  -2.86468,   0.     ,   0.     ,  -0.99869,  -5.03332,
        -7.7501 ,  -7.2838 ,  -4.21365,  -0.68445,   0.     ,   0.     ,
         0.     ,   0.     ,   0.49957,   0.94559,   1.21312,   1.01922,
         0.58609,   0.42304,   0.74788,   1.21229,   1.23721,   0.52635,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.8426 ,   2.27205,
         2.8058 ,   2.35805,   1.46288,   0.89457,   1.09691,   1.79904,
         2.28564,   2.0398 ,   1.11131,   0.04426,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,  -3.22059,  -5.67507,  -5.82974,
        -3.24989,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,  -1.01539,
        -2.92212,  -2.80863,  -0.86681,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.2655 ,   0.31103,   0.5602 ,   0.63978,   0.34391,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.21579,
         1.19914,   2.17879,   2.84879,   3.0046 ,   2.56763,   1.59991,
         0.3164 ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
        -0.05146,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,  -1.06699,  -3.18183,  -4.53292,  -4.05864,
        -1.90024,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.23001,   0.23853,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.     ,   0.     ,  -0.91444,  -1.36307,
        -0.09154,   0.     ,   0.     ,   0.     ,   0.     ,   0.     ,
         0.     ,   0.     ,   0.
    ])

    Fy_rub = np.array([
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
       -2.04429, -4.38016, -6.57714, -8.28573, -9.37587, -9.75933,
       -9.25813, -7.69222, -5.19938, -2.48476, -0.61176, -0.14117,
       -0.29231,  0.59298,  3.76722,  7.17877,  8.50843,  6.9303 ,
        3.77043,  1.38873,  1.14884,  2.47906,  3.70296,  3.57058,
        2.16593,  0.72693,  0.46617,  1.3243 ,  2.08718,  1.74357,
        0.372  ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  1.40459,  3.90508,  6.08173,
        6.05774,  3.36298,  0.     ,  0.     ,  0.     ,  0.     ,
        1.34137,  4.74269,  5.66655,  3.75628,  0.28809, -1.61396,
       -2.62114, -2.77201, -2.47978, -2.29098, -2.50753, -3.08839,
       -3.77908, -4.27479, -4.34706, -3.94654, -3.20655, -2.31137,
       -1.36806, -0.4128 ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     , -0.22816, -2.7129 , -3.78547, -3.20913,
       -1.63064, -0.16281,  0.     , -0.33417, -1.19099, -1.40999,
       -0.82791,  0.01215,  0.     ,  0.     ,  1.12437,  3.42666,
        6.4417 ,  7.74143,  6.02904,  2.16009,  0.     ,  0.     ,
        0.     ,  0.     ,  1.33055,  2.8963 ,  2.70812,  1.3118 ,
        0.0632 , -0.1465 , -0.0018 ,  0.20072,  0.07503, -0.11498,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     , -0.1147 , -0.09399,
       -0.37461, -0.66764, -0.77524, -0.81072, -1.18813, -2.17631,
       -3.40636, -4.0075 , -3.27515, -1.24315,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     , -1.72064, -2.63464, -2.10851,
       -0.72111,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.12732,
       -0.13905,  0.13201,  0.51607,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.88088,  2.75998,  3.26768,  2.03091,  0.01545,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     , -0.20874,
        0.05031, -0.0122 , -0.32162, -0.75307, -1.07413, -1.04887,
       -0.53796,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
       -0.35022,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.18449, -0.16341, -0.07524,  0.3703 ,
        0.6314 ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     , -0.06506, -0.06606,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.     ,  0.     ,  0.82617,  1.15647,
        0.53299,  0.     ,  0.     ,  0.     ,  0.     ,  0.     ,
        0.     ,  0.     ,  0.
    ])
    # fmt: on

    assert_allclose(rub.forces_rub[rub.posRUB * 6 + 0, :], Fx_rub, rtol=3e-2)
    assert_allclose(rub.forces_rub[rub.posRUB * 6 + 1, :], Fy_rub, rtol=3e-2)
